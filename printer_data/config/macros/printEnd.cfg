[gcode_macro PRINT_END]
gcode:
    # --- 1. Variables ---
    {% set th = printer.toolhead %}
    {% set park_x = th.axis_maximum.x - 2 %}
    {% set park_y = th.axis_maximum.y - 2 %}
    
    # Calculate "Bed Drop" height (Max Z - 15mm)
    {% set park_z = th.axis_maximum.z - 15 %}
    
    # --- 2. Safe Exit ---
    M400                         ; Wait for moves to finish
    G92 E0                       ; Zero extruder
    G1 E-1.0 F3600               ; Retract 1mm (Safe for Direct Drive)
    
    TURN_OFF_HEATERS
    M107                         ; Turn off part fan
    M118 Heaters and Fan disabled.
    
    # --- 3. Park & Present ---
    M117 Parking...
    G90                          ; Absolute positioning
    
    # Move Nozzle to back right (Park)
    G0 X{park_x} Y{park_y} F15000 
    M118 Parked nozzle at X{park_x} Y{park_y}.
    
    # Drop Bed to bottom (Present Print)
    # Only move down if we are currently higher than the park position
    {% if th.position.z < park_z %}
        M118 Dropping Bed to bottom...
        G0 Z{park_z} F3000
    {% else %}
        M118 Bed already at bottom.
    {% endif %}

    # --- 4. Cleanup (Verbose) ---
    M117 Clearing Systems...
    
    # Bed Mesh
    BED_MESH_CLEAR
    M118 >>> Bed Mesh Cleared.

    # Skew
    SET_SKEW CLEAR=1
    M118 >>> Skew Profile Cleared.

    # Pressure Advance
    SET_PRESSURE_ADVANCE ADVANCE=0.0
    M118 >>> Pressure Advance Reset to 0.0.
    
    # Disable Steppers (XY and Extruder ONLY). 
    # Keep Z enabled to hold the bed in place.
    M84 X Y E 

    # --- 5. Feedback ---
    M117 Print Finished
    M118 >>> PRINT COMPLETE. System Cooled.
    
    # Clear LCD after 10s
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=10